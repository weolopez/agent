<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Programming Loop</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 20px;
        }

        .workflow-area {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-panel, .agent-status {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .agent-flow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(90deg, #f8f9fa, #e9ecef);
            border-radius: 12px;
            border: 2px solid #dee2e6;
        }

        .agent {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .agent.active {
            transform: scale(1.1);
        }

        .agent-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .agent.active .agent-icon {
            border-color: #007bff;
            box-shadow: 0 0 20px rgba(0,123,255,0.4);
        }

        .analyst .agent-icon { background: linear-gradient(135deg, #ff6b6b, #ee5a5a); }
        .planner .agent-icon { background: linear-gradient(135deg, #4ecdc4, #44b1b1); }
        .developer .agent-icon { background: linear-gradient(135deg, #45b7d1, #3a9bc1); }
        .tester .agent-icon { background: linear-gradient(135deg, #96ceb4, #7fb069); }

        .agent-name {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
        }

        .agent.active .agent-name {
            color: #007bff;
        }

        .arrow {
            font-size: 20px;
            color: #007bff;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .current-output {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #007bff;
            min-height: 400px;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .output-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #333;
        }

        .output-content {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #e9ecef;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #333;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        .input-group input, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .status-item:last-child {
            border-bottom: none;
        }

        .status-label {
            font-weight: 600;
            color: #666;
        }

        .status-value {
            color: #333;
        }

        .iteration-history {
            margin-top: 20px;
        }

        .history-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #007bff;
        }

        .history-header {
            font-weight: 600;
            margin-bottom: 5px;
            color: #007bff;
        }

        .history-content {
            font-size: 14px;
            color: #666;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .approval-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }

        .approval-section h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .feedback-preview {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .feedback-preview h5 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .feedback-content {
            background: white;
            border-radius: 4px;
            padding: 10px;
            border: 1px solid #e1f5fe;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
        }

        .feedback-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 10px 0;
        }

        .feedback-tag {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 15px;
            padding: 5px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .feedback-tag:hover {
            background: #e0e0e0;
        }

        .feedback-tag.selected {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .agent-flow {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .arrow {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Multi-Agent Programming Loop</h1>
            <p>Professional autonomous development workflow with Claude AI</p>
        </div>

        <div class="main-content">
            <div class="workflow-area">
                <div class="agent-flow">
                    <div class="agent analyst" data-agent="analyst">
                        <div class="agent-icon">🔍</div>
                        <div class="agent-name">Analyst</div>
                    </div>
                    <div class="arrow">→</div>
                    <div class="agent planner" data-agent="planner">
                        <div class="agent-icon">📋</div>
                        <div class="agent-name">Planner</div>
                    </div>
                    <div class="arrow">→</div>
                    <div class="agent developer" data-agent="developer">
                        <div class="agent-icon">💻</div>
                        <div class="agent-name">Developer</div>
                    </div>
                    <div class="arrow">→</div>
                    <div class="agent tester" data-agent="tester">
                        <div class="agent-icon">🧪</div>
                        <div class="agent-name">Tester</div>
                    </div>
                </div>

                <div class="current-output">
                    <div class="output-header">
                        <div class="output-title">Current Agent Output</div>
                        <div id="loadingIndicator" class="loading" style="display: none;"></div>
                    </div>
                    <div class="output-content" id="outputContent">
                        <em>No output yet. Configure your project and click "Start Analysis"</em>
                    </div>
                    
                    <div id="approvalSection" class="approval-section" style="display: none;">
                        <h4>Human Approval Required</h4>
                        <p>Please review the output above and decide how to proceed:</p>
                        
                        <div class="input-group" style="margin: 15px 0;">
                            <label for="humanFeedback">Feedback for next agent (optional):</label>
                            <textarea id="humanFeedback" rows="3" placeholder="Provide specific guidance, requirements, or concerns for the next agent..."></textarea>
                        </div>
                        
                        <div class="feedback-tags">
                            <small style="width: 100%; margin-bottom: 5px; display: block; color: #666;">Quick feedback tags (click to add):</small>
                        </div>
                        
                        <div class="control-group" style="margin-top: 15px;">
                            <button class="btn btn-success" onclick="approveAndContinue()">✓ Approve & Continue</button>
                            <button class="btn btn-warning" onclick="requestRevision()">⚠ Request Revision</button>
                            <button class="btn btn-danger" onclick="rejectAndStop()">✗ Reject & Stop</button>
                        </div>
                        
                        <div id="feedbackPreview" class="feedback-preview" style="display: none;">
                            <h5>Feedback to be sent to <span id="nextAgentName"></span>:</h5>
                            <div id="feedbackContent" class="feedback-content"></div>
                        </div>
                    </div>
                </div>

                <div class="iteration-history">
                    <h3>Iteration History</h3>
                    <div id="historyContainer">
                        <em>No iterations completed yet</em>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="control-panel">
                    <h3>Project Configuration</h3>
                    
                    <div class="input-group">
                        <label for="projectDescription">Project Description:</label>
                        <textarea id="projectDescription" rows="4" placeholder="Describe what you want to build in detail...">Create a standalone web component that implements xeyes - a classic desktop widget where animated eyes follow the mouse cursor around the screen.</textarea>
                    </div>

                    <div class="input-group">
                        <label for="maxIterations">Max Iterations:</label>
                        <input type="number" id="maxIterations" value="3" min="1" max="10">
                    </div>

                    <div class="input-group">
                        <label for="maxTokens">Max Tokens per Agent:</label>
                        <input type="number" id="maxTokens" value="4000" min="1000" max="8000">
                    </div>

                    <div class="controls">
                        <button class="btn btn-primary" onclick="startWorkflow()" id="startBtn">
                            🚀 Start Analysis
                        </button>
                        
                        <div class="control-group">
                            <button class="btn btn-warning" onclick="pauseWorkflow()" id="pauseBtn" disabled>
                                ⏸ Pause
                            </button>
                            <button class="btn btn-danger" onclick="resetWorkflow()" id="resetBtn">
                                🔄 Reset
                            </button>
                        </div>
                    </div>
                </div>

                <div class="agent-status">
                    <h3>Workflow Status</h3>
                    
                    <div class="status-item">
                        <div class="status-label">Current Agent:</div>
                        <div class="status-value" id="currentAgent">None</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label">Iteration:</div>
                        <div class="status-value" id="currentIteration">0</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label">Status:</div>
                        <div class="status-value" id="workflowStatus">Ready</div>
                    </div>
                    
                    <div class="status-item">
                        <div class="status-label">Progress:</div>
                        <div class="status-value" id="progress">0%</div>
                    </div>

                    <div class="status-item">
                        <div class="status-label">API Calls:</div>
                        <div class="status-value" id="apiCalls">0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let currentState = {
            agent: null,
            iteration: 0,
            isRunning: false,
            isPaused: false,
            maxIterations: 3,
            projectDescription: '',
            history: [],
            currentOutput: null,
            awaitingApproval: false,
            humanFeedback: null,
            feedbackHistory: [],
            apiCallCount: 0
        };

        // Agent configurations with professional prompts
        const agents = {
            analyst: {
                name: 'Analyst',
                icon: '🔍',
                prompt: `You are a PROFESSIONAL SOFTWARE ANALYST in a multi-agent development system.

PROJECT TO ANALYZE: {project_description}

CONTEXT:
- Current iteration: {iteration_number}
- Previous cycle results: {previous_results}
- Human feedback from previous steps: {human_feedback}

YOUR RESPONSIBILITIES:
1. Analyze the project requirements thoroughly
2. Identify technical challenges and constraints
3. Break down the project into implementable components
4. Assess feasibility and recommend the best approach
5. Define clear success criteria

HUMAN FEEDBACK TO CONSIDER: {feedback_context}

Respond with a comprehensive JSON analysis containing:
{
  "project_analysis": "Detailed analysis of the project requirements",
  "technical_challenges": ["challenge1", "challenge2"],
  "required_components": ["component1", "component2"],
  "technology_recommendations": ["tech1", "tech2"],
  "implementation_approach": "Recommended development strategy",
  "success_criteria": ["criteria1", "criteria2"],
  "estimated_complexity": "low|medium|high",
  "key_considerations": ["consideration1", "consideration2"],
  "next_phase_requirements": "What the planner needs to focus on"
}

Focus on web components, modern JavaScript, and professional development practices.`,
                nextAgent: 'planner'
            },
            planner: {
                name: 'Planner',
                icon: '📋',
                prompt: `You are a PROFESSIONAL SOFTWARE ARCHITECT AND PLANNER in a multi-agent development system.

ANALYST INPUT: {analyst_output}

HUMAN FEEDBACK: {feedback_context}

YOUR RESPONSIBILITIES:
1. Create detailed technical specifications
2. Design component architecture
3. Plan implementation phases
4. Define testing strategies
5. Identify dependencies and risks

Respond with a comprehensive JSON plan:
{
  "architecture_design": {
    "main_component": "Primary component name and purpose",
    "sub_components": ["component1", "component2"],
    "data_flow": "How data flows between components",
    "event_system": "Event handling strategy"
  },
  "implementation_plan": {
    "phase_1": {
      "name": "Phase name",
      "tasks": ["task1", "task2"],
      "deliverables": ["file1.js", "file2.css"],
      "estimated_hours": 8
    }
  },
  "technical_specifications": {
    "web_component_api": "Custom Elements v1",
    "browser_support": "Modern browsers (ES6+)",
    "styling_approach": "Shadow DOM with CSS custom properties",
    "performance_targets": "60fps, <100ms response time"
  },
  "testing_strategy": {
    "unit_tests": ["test1", "test2"],
    "integration_tests": ["test1"],
    "manual_tests": ["test1"]
  },
  "risk_mitigation": ["risk1_solution", "risk2_solution"],
  "developer_guidelines": "Key implementation guidelines for the developer"
}

Create production-ready, scalable architecture plans.`,
                nextAgent: 'developer'
            },
            developer: {
                name: 'Developer',
                icon: '💻',
                prompt: `You are a PROFESSIONAL SENIOR DEVELOPER in a multi-agent development system.

PLANNER INPUT: {planner_output}

HUMAN FEEDBACK: {feedback_context}

YOUR RESPONSIBILITIES:
1. Implement the planned architecture with production-ready code
2. Follow modern web development best practices
3. Create clean, maintainable, and well-documented code
4. Implement proper error handling and edge cases
5. Ensure accessibility and performance standards

CODING STANDARDS:
- ES6+ features and modern JavaScript
- Custom Elements v1 API for web components
- Shadow DOM for encapsulation
- CSS custom properties for theming
- Comprehensive error handling
- JSDoc comments for documentation
- Semantic HTML and ARIA attributes
- Performance optimizations

Respond with complete implementation in JSON format:
{
  "implementation_summary": "What was built and key features",
  "main_files": [
    {
      "filename": "component-name.js",
      "content": "COMPLETE working JavaScript code",
      "description": "Purpose and functionality"
    },
    {
      "filename": "component-name.css",
      "content": "COMPLETE CSS styling code",
      "description": "Styling approach and features"
    }
  ],
  "usage_example": {
    "html": "<custom-element></custom-element>",
    "javascript": "// Usage examples",
    "description": "How to use the component"
  },
  "features_implemented": ["feature1", "feature2"],
  "accessibility_features": ["feature1", "feature2"],
  "performance_optimizations": ["optimization1", "optimization2"],
  "browser_compatibility": "Supported browsers and versions",
  "known_limitations": ["limitation1", "limitation2"],
  "next_steps": ["enhancement1", "enhancement2"]
}

Write production-ready, complete, and functional code.`,
                nextAgent: 'tester'
            },
            tester: {
                name: 'Tester',
                icon: '🧪',
                prompt: `You are a PROFESSIONAL QA ENGINEER AND TESTER in a multi-agent development system.

DEVELOPER OUTPUT: {developer_output}

HUMAN FEEDBACK: {feedback_context}

YOUR RESPONSIBILITIES:
1. Thoroughly test the implemented solution
2. Verify all requirements are met
3. Test edge cases and error conditions
4. Validate performance and accessibility
5. Provide detailed feedback and recommendations

TESTING AREAS:
- Functionality testing against requirements
- Cross-browser compatibility
- Performance benchmarks
- Accessibility compliance (WCAG 2.1)
- Code quality assessment
- Security considerations
- Edge case handling
- Error recovery

Respond with comprehensive test results in JSON format:
{
  "test_summary": {
    "overall_status": "pass|fail|partial",
    "tests_run": 25,
    "tests_passed": 23,
    "tests_failed": 2,
    "critical_issues": 0
  },
  "functional_tests": [
    {
      "test_name": "Core functionality test",
      "status": "pass|fail",
      "description": "What was tested",
      "result": "Detailed test result"
    }
  ],
  "performance_results": {
    "load_time": "< 100ms",
    "memory_usage": "< 5MB",
    "cpu_usage": "< 10%",
    "frame_rate": "60fps"
  },
  "accessibility_audit": {
    "wcag_compliance": "AA level",
    "issues_found": ["issue1", "issue2"],
    "score": "95/100"
  },
  "browser_compatibility": {
    "chrome": "✓ Works perfectly",
    "firefox": "✓ Works perfectly", 
    "safari": "⚠ Minor styling issue",
    "edge": "✓ Works perfectly"
  },
  "security_assessment": {
    "xss_vulnerabilities": "None found",
    "input_validation": "Properly implemented",
    "recommendations": ["rec1", "rec2"]
  },
  "bugs_found": [
    {
      "severity": "high|medium|low",
      "description": "Bug description",
      "steps_to_reproduce": ["step1", "step2"],
      "expected_behavior": "What should happen",
      "actual_behavior": "What actually happens"
    }
  ],
  "recommendations": ["recommendation1", "recommendation2"],
  "ready_for_production": true,
  "next_iteration_focus": ["focus_area1", "focus_area2"]
}

Be thorough, professional, and provide actionable feedback.`,
                nextAgent: 'analyst'
            }
        };

        // Initialize application
        function init() {
            updateUI();
            setupEventListeners();
            setupFeedbackTags();
        }

        function setupEventListeners() {
            // Auto-save project description
            document.getElementById('projectDescription').addEventListener('input', function(e) {
                localStorage.setItem('multiAgentProjectDescription', e.target.value);
            });

            // Load saved project description
            const saved = localStorage.getItem('multiAgentProjectDescription');
            if (saved) {
                document.getElementById('projectDescription').value = saved;
            }

            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'Enter':
                            if (!currentState.isRunning) {
                                startWorkflow();
                            } else if (currentState.awaitingApproval) {
                                approveAndContinue();
                            }
                            e.preventDefault();
                            break;
                        case 'r':
                            if (!currentState.isRunning) {
                                resetWorkflow();
                            }
                            e.preventDefault();
                            break;
                        case 'p':
                            if (currentState.isRunning) {
                                pauseWorkflow();
                            }
                            e.preventDefault();
                            break;
                    }
                }
            });
        }

        function setupFeedbackTags() {
            const tagsContainer = document.querySelector('.feedback-tags');
            const commonTags = [
                'Add error handling',
                'Improve accessibility', 
                'Optimize performance',
                'Enhance security',
                'Better documentation',
                'Simplify code',
                'Add validation',
                'More tests needed'
            ];

            commonTags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'feedback-tag';
                tagElement.textContent = tag;
                tagElement.onclick = () => addQuickFeedback(tag);
                tagsContainer.appendChild(tagElement);
            });
        }

        function addQuickFeedback(tag) {
            const feedbackTextarea = document.getElementById('humanFeedback');
            const currentValue = feedbackTextarea.value.trim();
            const newValue = currentValue ? `${currentValue}\n- ${tag}` : `- ${tag}`;
            feedbackTextarea.value = newValue;
            feedbackTextarea.dispatchEvent(new Event('input'));
        }

        // Workflow control functions
        async function startWorkflow() {
            if (currentState.isRunning) return;
            
            currentState.projectDescription = document.getElementById('projectDescription').value.trim();
            currentState.maxIterations = parseInt(document.getElementById('maxIterations').value);
            
            if (!currentState.projectDescription) {
                showError('Please provide a project description');
                return;
            }
            
            currentState.isRunning = true;
            currentState.isPaused = false;
            currentState.agent = 'analyst';
            currentState.iteration = 1;
            currentState.apiCallCount = 0;
            
            updateUI();
            await runCurrentAgent();
        }

        function pauseWorkflow() {
            currentState.isPaused = true;
            updateUI();
        }

        function resetWorkflow() {
            currentState = {
                agent: null,
                iteration: 0,
                isRunning: false,
                isPaused: false,
                maxIterations: 3,
                projectDescription: '',
                history: [],
                currentOutput: null,
                awaitingApproval: false,
                humanFeedback: null,
                feedbackHistory: [],
                apiCallCount: 0
            };
            
            document.getElementById('historyContainer').innerHTML = '<em>No iterations completed yet</em>';
            document.getElementById('outputContent').innerHTML = '<em>No output yet. Configure your project and click "Start Analysis"</em>';
            document.getElementById('humanFeedback').value = '';
            document.getElementById('approvalSection').style.display = 'none';
            
            updateUI();
        }

        // Claude API Integration
        async function callClaudeAPI(agentType, context) {
            const agent = agents[agentType];
            let prompt = agent.prompt;
            
            // Replace placeholders with actual context
            prompt = prompt.replace('{project_description}', currentState.projectDescription);
            prompt = prompt.replace('{iteration_number}', currentState.iteration);
            prompt = prompt.replace('{previous_results}', JSON.stringify(context.previous_results || [], null, 2));
            prompt = prompt.replace('{human_feedback}', JSON.stringify(context.human_feedback || {}, null, 2));
            prompt = prompt.replace('{feedback_context}', context.feedback_summary || 'No specific feedback provided');
            
            // Add agent-specific context
            if (agentType === 'planner' && context.analyst_output) {
                prompt = prompt.replace('{analyst_output}', JSON.stringify(context.analyst_output, null, 2));
            }
            if (agentType === 'developer' && context.planner_output) {
                prompt = prompt.replace('{planner_output}', JSON.stringify(context.planner_output, null, 2));
            }
            if (agentType === 'tester' && context.developer_output) {
                prompt = prompt.replace('{developer_output}', JSON.stringify(context.developer_output, null, 2));
            }

            try {
                currentState.apiCallCount++;
                updateUI();

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: parseInt(document.getElementById('maxTokens').value),
                        messages: [
                            {
                                role: "user",
                                content: prompt
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                let responseText = data.content[0].text;

                // Clean up potential markdown formatting
                responseText = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();

                return responseText;
            } catch (error) {
                console.error('Error calling Claude API:', error);
                throw new Error(`Claude API Error: ${error.message}`);
            }
        }

        // Agent execution
        async function runCurrentAgent() {
            if (!currentState.isRunning || currentState.isPaused) return;
            
            const agent = agents[currentState.agent];
            if (!agent) return;
            
            updateUI();
            showLoading(true);
            
            try {
                // Prepare context for the current agent
                const context = {
                    iteration: currentState.iteration,
                    project_description: currentState.projectDescription,
                    previous_results: currentState.history.slice(-3),
                    human_feedback: currentState.humanFeedback,
                    feedback_summary: generateFeedbackSummary()
                };

                // Add specific context based on agent type
                if (currentState.agent === 'planner' && currentState.history.length > 0) {
                    const lastAnalyst = currentState.history.find(h => h.agent === 'analyst' && h.iteration === currentState.iteration);
                    if (lastAnalyst) {
                        context.analyst_output = JSON.parse(lastAnalyst.content);
                    }
                }
                
                if (currentState.agent === 'developer' && currentState.history.length > 0) {
                    const lastPlanner = currentState.history.find(h => h.agent === 'planner' && h.iteration === currentState.iteration);
                    if (lastPlanner) {
                        context.planner_output = JSON.parse(lastPlanner.content);
                    }
                }
                
                if (currentState.agent === 'tester' && currentState.history.length > 0) {
                    const lastDeveloper = currentState.history.find(h => h.agent === 'developer' && h.iteration === currentState.iteration);
                    if (lastDeveloper) {
                        context.developer_output = JSON.parse(lastDeveloper.content);
                    }
                }

                // Call Claude API
                const output = await callClaudeAPI(currentState.agent, context);
                
                currentState.currentOutput = {
                    agent: currentState.agent,
                    content: output,
                    timestamp: new Date().toISOString(),
                    context_used: context
                };

                // Clear used feedback
                currentState.humanFeedback = null;
                
                showLoading(false);
                displayOutput(output);
                
                // Show approval section
                currentState.awaitingApproval = true;
                document.getElementById('approvalSection').style.display = 'block';
                
                // Show next agent name in feedback preview
                const nextAgent = agents[currentState.agent].nextAgent;
                let nextAgentName;
                if (nextAgent === 'analyst' && currentState.iteration >= currentState.maxIterations) {
                    nextAgentName = 'Workflow Complete';
                } else if (nextAgent === 'analyst') {
                    nextAgentName = 'Analyst (Next Iteration)';
                } else {
                    nextAgentName = agents[nextAgent].name;
                }
                document.getElementById('nextAgentName').textContent = nextAgentName;
                
                setupFeedbackPreview();
                
            } catch (error) {
                showLoading(false);
                showError(`Error running ${agent.name}: ${error.message}`);
                currentState.isRunning = false;
                currentState.awaitingApproval = false;
            }
            
            updateUI();
        }

        function generateFeedbackSummary() {
            if (!currentState.feedbackHistory.length) return 'No previous feedback';
            
            const recentFeedback = currentState.feedbackHistory.slice(-3);
            return recentFeedback.map(f => `${f.type}: ${f.content}`).join('\n');
        }

        // User approval functions
        async function approveAndContinue() {
            if (!currentState.awaitingApproval) return;
            
            // Capture human feedback
            const feedbackText = document.getElementById('humanFeedback').value.trim();
            const humanFeedback = captureFeedback(feedbackText, 'approval');
            
            // Add to history
            addToHistory(currentState.currentOutput);
            
            // Store feedback for next agent
            if (humanFeedback) {
                currentState.humanFeedback = humanFeedback;
                currentState.feedbackHistory.push(humanFeedback);
            }
            
            // Move to next agent
            const nextAgent = agents[currentState.agent].nextAgent;
            
            if (nextAgent === 'analyst' && currentState.iteration < currentState.maxIterations) {
                // Start new iteration
                currentState.iteration++;
                currentState.agent = 'analyst';
            } else if (nextAgent !== 'analyst') {
                // Continue with next agent in current iteration
                currentState.agent = nextAgent;
            } else {
                // Workflow complete
                completeWorkflow();
                return;
            }
            
            // Clear approval UI
            currentState.awaitingApproval = false;
            document.getElementById('approvalSection').style.display = 'none';
            document.getElementById('humanFeedback').value = '';
            
            updateUI();
            await runCurrentAgent();
        }

        async function requestRevision() {
            const feedbackText = document.getElementById('humanFeedback').value.trim();
            let revisionReason = feedbackText;
            
            if (!revisionReason) {
                revisionReason = prompt("Please describe what needs to be revised:");
                if (!revisionReason) return;
            }
            
            const humanFeedback = captureFeedback(revisionReason, 'revision');
            
            // Add revision note to current output
            if (currentState.currentOutput) {
                currentState.currentOutput.revision_requested = revisionReason;
                currentState.currentOutput.status = 'revision_requested';
                currentState.currentOutput.human_feedback = humanFeedback;
            }
            
            // Store feedback for current agent re-run
            currentState.humanFeedback = humanFeedback;
            currentState.feedbackHistory.push(humanFeedback);
            
            // Add to history with revision status
            addToHistory(currentState.currentOutput);
            
            // Re-run current agent with revision context
            currentState.awaitingApproval = false;
            document.getElementById('approvalSection').style.display = 'none';
            document.getElementById('humanFeedback').value = '';
            
            showSuccess(`Revision requested for ${agents[currentState.agent].name}. Re-running with your feedback.`);
            
            updateUI();
            await runCurrentAgent();
        }

        function rejectAndStop() {
            const feedbackText = document.getElementById('humanFeedback').value.trim();
            let rejectionReason = feedbackText;
            
            if (!rejectionReason) {
                rejectionReason = prompt("Please provide a reason for stopping the workflow:");
                if (!rejectionReason) return;
            }
            
            const humanFeedback = captureFeedback(rejectionReason, 'rejection');
            
            currentState.isRunning = false;
            currentState.awaitingApproval = false;
            document.getElementById('approvalSection').style.display = 'none';
            
            addToHistory({
                agent: 'human',
                content: `Workflow stopped by user: ${rejectionReason}`,
                timestamp: new Date().toISOString(),
                status: 'rejected',
                human_feedback: humanFeedback
            });
            
            currentState.feedbackHistory.push(humanFeedback);
            
            updateUI();
            showSuccess('Workflow stopped successfully.');
        }

        function captureFeedback(text, type) {
            if (!text) return null;
            
            return {
                content: text,
                type: type,
                timestamp: new Date().toISOString(),
                iteration: currentState.iteration,
                from_agent: currentState.agent,
                to_agent: type === 'revision' ? currentState.agent : agents[currentState.agent].nextAgent,
                tags: extractFeedbackTags(text)
            };
        }

        function extractFeedbackTags(text) {
            const tags = [];
            const lowerText = text.toLowerCase();
            
            if (lowerText.includes('security') || lowerText.includes('secure')) tags.push('security');
            if (lowerText.includes('performance') || lowerText.includes('speed')) tags.push('performance');
            if (lowerText.includes('ui') || lowerText.includes('interface') || lowerText.includes('design')) tags.push('ui/ux');
            if (lowerText.includes('test') || lowerText.includes('bug')) tags.push('testing');
            if (lowerText.includes('accessibility') || lowerText.includes('a11y')) tags.push('accessibility');
            if (lowerText.includes('refactor') || lowerText.includes('clean')) tags.push('code-quality');
            if (lowerText.includes('feature') || lowerText.includes('functionality')) tags.push('features');
            if (lowerText.includes('documentation') || lowerText.includes('docs')) tags.push('documentation');
            
            return tags;
        }

        function setupFeedbackPreview() {
            const feedbackTextarea = document.getElementById('humanFeedback');
            const feedbackPreview = document.getElementById('feedbackPreview');
            const feedbackContent = document.getElementById('feedbackContent');
            
            feedbackTextarea.addEventListener('input', function() {
                const text = this.value.trim();
                if (text) {
                    feedbackPreview.style.display = 'block';
                    const feedback = captureFeedback(text, 'preview');
                    feedbackContent.textContent = JSON.stringify(feedback, null, 2);
                } else {
                    feedbackPreview.style.display = 'none';
                }
            });
        }

        // Utility functions
        function addToHistory(output) {
            currentState.history.push({
                iteration: currentState.iteration,
                agent: output.agent,
                content: output.content,
                timestamp: output.timestamp,
                status: output.status || 'approved',
                human_feedback: output.human_feedback
            });
            
            updateHistoryDisplay();
        }

        function updateHistoryDisplay() {
            const container = document.getElementById('historyContainer');
            
            if (currentState.history.length === 0) {
                container.innerHTML = '<em>No iterations completed yet</em>';
                return;
            }
            
            container.innerHTML = currentState.history.map(item => `
                <div class="history-item">
                    <div class="history-header">
                        Iteration ${item.iteration} - ${agents[item.agent]?.name || item.agent} 
                        <span style="color: ${item.status === 'approved' ? '#28a745' : item.status === 'rejected' ? '#dc3545' : '#ffc107'}">(${item.status})</span>
                        ${item.human_feedback ? `<span style="color: #007bff; font-size: 12px;">📝 Feedback</span>` : ''}
                    </div>
                    <div class="history-content">
                        ${new Date(item.timestamp).toLocaleString()}
                        ${item.human_feedback ? `<br><strong>Human Feedback:</strong> ${item.human_feedback.content.substring(0, 100)}...` : ''}
                        <br>
                        <details>
                            <summary>View Output (${item.content.length} chars)</summary>
                            <pre style="font-size: 12px; margin-top: 10px; white-space: pre-wrap;">${item.content.substring(0, 500)}${item.content.length > 500 ? '...' : ''}</pre>
                        </details>
                    </div>
                </div>
            `).join('');
        }

        function displayOutput(content) {
            const outputElement = document.getElementById('outputContent');
            
            try {
                // Try to parse and format JSON for better readability
                const parsed = JSON.parse(content);
                outputElement.textContent = JSON.stringify(parsed, null, 2);
            } catch (e) {
                // If not JSON, display as-is
                outputElement.textContent = content;
            }
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const outputContent = document.getElementById('outputContent');
            outputContent.parentNode.insertBefore(errorDiv, outputContent.nextSibling);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            const outputContent = document.getElementById('outputContent');
            outputContent.parentNode.insertBefore(successDiv, outputContent.nextSibling);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 3000);
        }

        function updateUI() {
            // Update agent visual state
            document.querySelectorAll('.agent').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.agent === currentState.agent) {
                    el.classList.add('active');
                }
            });
            
            // Update status panel
            document.getElementById('currentAgent').textContent = 
                currentState.agent ? agents[currentState.agent].name : 'None';
            document.getElementById('currentIteration').textContent = currentState.iteration;
            document.getElementById('workflowStatus').textContent = 
                currentState.isRunning ? 
                    (currentState.isPaused ? 'Paused' : 
                     currentState.awaitingApproval ? 'Awaiting Approval' : 'Running') : 
                'Ready';
            
            const progress = currentState.maxIterations > 0 ? 
                Math.round((currentState.iteration / currentState.maxIterations) * 100) : 0;
            document.getElementById('progress').textContent = `${progress}%`;
            document.getElementById('apiCalls').textContent = currentState.apiCallCount;
            
            // Update button states
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const resetBtn = document.getElementById('resetBtn');
            
            startBtn.disabled = currentState.isRunning;
            pauseBtn.disabled = !currentState.isRunning || currentState.awaitingApproval;
            resetBtn.disabled = currentState.isRunning && !currentState.isPaused && !currentState.awaitingApproval;
            
            if (currentState.isRunning && !currentState.awaitingApproval) {
                startBtn.innerHTML = '<div class="loading"></div> Running...';
            } else {
                startBtn.innerHTML = '🚀 Start Analysis';
            }
        }

        function completeWorkflow() {
            currentState.isRunning = false;
            currentState.awaitingApproval = false;
            document.getElementById('approvalSection').style.display = 'none';
            
            addToHistory({
                agent: 'system',
                content: JSON.stringify({
                    message: 'Workflow completed successfully!',
                    total_iterations: currentState.iteration,
                    api_calls_made: currentState.apiCallCount,
                    feedback_items: currentState.feedbackHistory.length,
                    completion_time: new Date().toISOString()
                }, null, 2),
                timestamp: new Date().toISOString(),
                status: 'completed'
            });
            
            updateUI();
            showCompletionSummary();
        }

        function showCompletionSummary() {
            const summaryHtml = `
                <div style="background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 20px; border-radius: 8px; margin: 20px 0;">
                    <h3>🎉 Workflow Complete!</h3>
                    <p><strong>Project:</strong> ${currentState.projectDescription.substring(0, 100)}...</p>
                    <p><strong>Iterations Completed:</strong> ${currentState.iteration}</p>
                    <p><strong>API Calls Made:</strong> ${currentState.apiCallCount}</p>
                    <p><strong>Human Feedback Items:</strong> ${currentState.feedbackHistory.length}</p>
                    <br>
                    <button class="btn btn-primary" onclick="downloadResults()">📁 Download Results</button>
                    <button class="btn btn-success" onclick="resetWorkflow()" style="margin-left: 10px;">🔄 Start New Project</button>
                </div>
            `;
            
            const outputContent = document.getElementById('outputContent');
            outputContent.innerHTML = summaryHtml;
        }

        function downloadResults() {
            const results = {
                project: currentState.projectDescription,
                iterations: currentState.iteration,
                api_calls: currentState.apiCallCount,
                history: currentState.history,
                feedback_history: currentState.feedbackHistory,
                summary: {
                    total_steps: currentState.history.length,
                    approved_steps: currentState.history.filter(h => h.status === 'approved').length,
                    success_rate: Math.round((currentState.history.filter(h => h.status === 'approved').length / currentState.history.length) * 100)
                },
                generated_at: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `multi-agent-results-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Initialize the application
        init();
    </script>
</body>
</html>

